# =============================================================================
# IdaraOS - Database Initialization Container
# =============================================================================
#
# WORKFLOW (Prototyping Phase):
# -----------------------------
# Uses db:push to directly sync schema to database (no migration files needed)
# Schema changes: Edit apps/web/lib/db/schema/*.ts and redeploy
#
# FUTURE (Production with real data):
# -----------------------------------
# Switch to migrations when you have production data:
# 1. Generate: pnpm --filter web db:generate
# 2. Commit migration files
# 3. Change this container to use db:migrate:run
#
# =============================================================================

FROM node:22-alpine

RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/web/package.json ./apps/web/

RUN pnpm install --frozen-lockfile

COPY apps/web ./apps/web

ENV NODE_ENV=development

CMD ["sh", "-c", "\
echo '=========================================='; \
echo 'IdaraOS Database Schema Push'; \
echo '=========================================='; \
cd /app/apps/web; \
\
echo ''; \
echo 'ðŸ“‹ Pushing schema to database...'; \
npx drizzle-kit push --force; \
\
if [ $? -ne 0 ]; then \
  echo 'âŒ Schema push failed!'; \
  exit 1; \
fi; \
\
echo ''; \
echo 'ðŸ“‹ Seeding database...'; \
pnpm db:seed 2>&1 || true; \
\
echo ''; \
echo 'ðŸ“‹ Seeding RBAC...'; \
pnpm db:seed-rbac 2>&1 || true; \
\
echo ''; \
echo '=========================================='; \
echo 'âœ… Database ready!'; \
echo '=========================================='; \
echo ''; \
echo 'Credentials: admin@example.com / Admin123!'; \
"]
