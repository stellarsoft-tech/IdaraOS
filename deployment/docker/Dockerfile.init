# =============================================================================
# IdaraOS - Database Initialization Container
# =============================================================================
#
# WORKFLOW:
# ---------
# LOCAL DEV (prototyping):  pnpm db:push (fast, no migrations)
# LOCAL DEV (testing):      pnpm db:migrate:run
# CI/CD & PRODUCTION:       This container runs db:migrate:run
#
# ADDING SCHEMA CHANGES:
# ----------------------
# 1. Edit apps/web/lib/db/schema/*.ts
# 2. Run: pnpm --filter web db:generate
# 3. Review generated SQL in apps/web/drizzle/
# 4. Commit: *.sql + meta/_journal.json + meta/*_snapshot.json
# 5. Deploy - this container applies migrations automatically
#
# =============================================================================

FROM node:22-alpine

RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/web/package.json ./apps/web/

RUN pnpm install --frozen-lockfile

COPY apps/web ./apps/web

ENV NODE_ENV=development

CMD ["sh", "-c", "\
echo '=========================================='; \
echo 'IdaraOS Database Migrations'; \
echo '=========================================='; \
cd /app/apps/web; \
\
echo ''; \
echo 'ðŸ“‹ Checking migration status...'; \
pnpm db:migrate:status 2>/dev/null || echo 'First run - no migrations applied yet'; \
\
echo ''; \
echo 'ðŸ“‹ Running pending migrations...'; \
pnpm db:migrate:run; \
\
if [ $? -ne 0 ]; then \
  echo 'âŒ Migration failed!'; \
  exit 1; \
fi; \
\
echo ''; \
echo 'ðŸ“‹ Seeding database...'; \
pnpm db:seed 2>&1 || true; \
\
echo ''; \
echo 'ðŸ“‹ Seeding RBAC...'; \
pnpm db:seed-rbac 2>&1 || true; \
\
echo ''; \
echo '=========================================='; \
echo 'âœ… Database ready!'; \
echo '=========================================='; \
echo ''; \
echo 'Credentials: admin@example.com / Admin123!'; \
"]
