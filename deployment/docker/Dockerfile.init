# =============================================================================
# IdaraOS - Database Initialization Container
# =============================================================================
#
# PRODUCTION WORKFLOW:
# --------------------
# Uses Drizzle migrations for safe, versioned schema changes:
# 1. Developer makes schema changes in apps/web/lib/db/schema/*.ts
# 2. Developer runs: pnpm --filter web db:generate
# 3. Developer commits migration files in apps/web/drizzle/
# 4. On deployment, this container runs migrations automatically
#
# DEVELOPMENT/PROTOTYPING:
# ------------------------
# For rapid iteration without migrations, use docker-compose.dev.yml
# which uses Dockerfile.init.dev with db:push instead
#
# =============================================================================

FROM node:22-alpine

RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/web/package.json ./apps/web/

RUN pnpm install --frozen-lockfile

COPY apps/web ./apps/web

ENV NODE_ENV=production

CMD ["sh", "-c", "\
echo '=========================================='; \
echo 'IdaraOS Database Migrations'; \
echo '=========================================='; \
cd /app/apps/web; \
\
echo ''; \
echo 'ðŸ“‹ Running database migrations...'; \
pnpm db:migrate:run; \
\
MIGRATE_EXIT=$?; \
if [ $MIGRATE_EXIT -ne 0 ]; then \
  echo ''; \
  echo 'âŒ Migration failed with exit code: '$MIGRATE_EXIT; \
  echo ''; \
  echo 'Troubleshooting:'; \
  echo '  1. Check if DATABASE_URL is correct'; \
  echo '  2. Check migration status: pnpm db:migrate:status'; \
  echo '  3. For db:push databases, run: pnpm db:baseline'; \
  exit 1; \
fi; \
\
echo ''; \
echo 'ðŸ“‹ Seeding database...'; \
pnpm db:seed 2>&1 || true; \
\
echo ''; \
echo 'ðŸ“‹ Seeding RBAC...'; \
pnpm db:seed-rbac 2>&1 || true; \
\
echo ''; \
echo 'ðŸ“‹ Running post-migration hooks...'; \
pnpm db:post-migrate 2>&1 || true; \
\
echo ''; \
echo '=========================================='; \
echo 'âœ… Database ready!'; \
echo '=========================================='; \
"]
